<div class="patients_list_show">
  <!-- был класс list_control_wrapper -->
  <%= render partial: 'patients/patient_short_info' %>

  <div class="list_control_patients_show">
      <h3>МЕТОД СЛОЖНОГО БАЛАНСА</h3>
      <%= form_with local: true, method: :get, url: points_complex_balance_path do |f| %>
      <% hidden_field_tag(:city, current_doctor.city) %>
      <%= hidden_field_tag(:patient_id, @patient.id) %>
      <div>
        <%= f.label " Выберите время сеанса: " %>
        <%= f.datetime_select :date, default: DateTime.now %>
      </div>
      <div>
        <%= f.label "День рождения пациента: " %>
        <%= f.datetime_select :birthdate, default: @patient.birthdate %>
        <%= f.submit   "Рассчитать", class: "form_button" %>
      </div>
      <% end %>
  </div>

  <div class="list_control_patients_show">
    <h3>МЕТОД У ЮНЬ ЛЮ ЦИ</h3>
    <%= form_with local: true, method: :get, url: points_wu_yun_liu_thi_trunk_path do |f| %>
    <%  hidden_field_tag(:city, current_doctor.city) %>
    <%= hidden_field_tag(:patient_id, @patient.id) %>
    <%= f.label " Выберите время: " %>
    <%= f.datetime_select :birthdate, default: @patient.birthdate %>
    <%= f.submit "Рассчитать" %>
    <% end %>
  </div>

  <div class="list_control_patients_show">
    <h3>МЕТОД ЛУННЫХ ДВОРЦОВ </h3>
    <%= form_tag points_lunar_palaces_path, method: "get" do  %>
    <%= hidden_field_tag(:patient_id, @patient.id) %>
    <%= label_tag " Выберите дату события: " %>
    <%= date_select(:date, nil, { start_year: 1930, end_year: Date.today.year, default: Date.today-30.years, order: [:day, :month, :year] } )%>
    <%= submit_tag "Рассчитать" %>
    <% end %>
  </div>

  <h3><%= label_tag( "Добавить сеанс") %></h3>
  <div class="list_control_patients_show">
      <%= form_with local: true, method: :post, url: visits_path, html: {onsubmit: "return confirm('Сохраняем сеанс?');"} do |f| %>
      <div>
        <%= hidden_field_tag(:patient_id, @patient.id) %>
      </div>
      <div>
        <%= f.label 'Дата сеанса:' %>
      </div>
      <div>
        <span>
          <%= f.datetime_select( :visited_at, default: DateTime.now) %>
        </span>
      </div>
      <div class="visit_description_label">
        <span class="bold_text_element">
          <%= f.label 'Примечание к сеанcу:' %>
        </span>
      </div>
      <div>
        <%= f.text_area :visit_description, :value => @patient.visits.last&.visit_description, rows:5, maxlength: '2000', class: 'form_text_area' %>
      </div>
      <div>
        <span class="bold_text_element">
          <%= f.label 'Лечение:' %>
        </span>
      </div>
      <div>
        <%= f.text_area :treatment, :value => @patient.visits.last&.treatment, rows:5, class: 'form_text_area' %>
      </div>
      <div>
        <%= f.submit "Добавить сеанс", class: 'btn-control form_button' %>
      </div>
      <% end %>

  </div>

  <h3>Сеансы:</h3>
  <div class="list_control_patients_show">
    <ol class="reversed_list">
      <% @visits.each do |visit| %>
        <ul class="reversed_list_without_bullets">
          <li>
             <%= visit.visit_description %>
          </li>
          <li>
            <%= visit.treatment %>
          </li>
          <li>
            <%= link_to 'Удалить сеанс', visit , action: :delete,  method: :delete, data: { confirm: 'Точно удалить сеанс?' }, class: 'btn-control'  %>
          </li>
        </ul>
        <li class="reversed_list_decsr bold_text_element">
          <%= visit.visited_at.strftime( "%d.%m.%y") + "г. в " + visit.visited_at.strftime( "%H:%M") + ". " + "Номер дня в году: " + visit.visited_at.strftime("%j") %>
        </li>
      <% end %>

    </ol>
    <div>
      <%= paginate @visits %>
    </div>

  </div>

  <div class="list_control_patients_show">
    <h3><%= label_tag( "Изменить данные пациента") %></h3>
    <%= form_with model: @patient, local: true, method: :patch, html: {onsubmit: "return confirm('Вы уверены?');"} do |f| %>
    <div class="bold_text_element  margin_bottom_1rem">
      <%= f.label "Имя" %>
      <%= f.text_field  :name  %>
    </div>
      <div class="bold_text_element  margin_bottom_1rem">
        <%= f.label 'Дата рождения' %>
        <%= f.datetime_select( :birthdate, start_year: 1920, end_year: DateTime.current.year, default: @patient.birthdate) %>
      </div>
      <div class="bold_text_element ">
         <%= f.label "Описание состояния:" %>
      </div>
      <div>
        <%= f.text_area :description, placeholder: 'Описание', rows: 5, maxlength: '2000', class: 'form_text_area' %>
      </div>
      <div class="bold_text_element">
        <%= f.label "Диагноз:" %>
      </div>
      <div>
        <%= f.text_area :diagnosis, placeholder: 'Диагноз', rows: 5, maxlength: '2000', class: 'form_text_area' %>
      </div>
      <%= f.label 'Место рождения (выбрать ближайший областной центр)' %>
      <%= f.collection_select(:city_id, @cities.sort_by{|s| s.name}, :id, :name,  {:selected => @patient.city&.id} ) %></p>
      <div>
        <h5>Tongue</h5>
        <%= f.collection_check_boxes :tongue_chinese_disease_ids, ChineseDisease.all, :id, :name %>
      </div>
      <div>
        <h5>Pulse</h5>
        <%= f.collection_check_boxes :pulse_chinese_disease_ids, ChineseDisease.all, :id, :name %>
      </div>
      <p><%= f.submit  "Обновить данные пациента", class: 'btn-control' %></p>
    <% end %>
    <div >
      <%= link_to 'Грохнуть пациента', patient_path(@patient), action: :delete,  method: :delete, data:{ confirm: 'Вы уверены, удаляем пациента из базы?' }, class: "li-control patient_delete_control" %>
    </div>
  </div>
</div>


